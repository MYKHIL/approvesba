<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA Pro Master - License Management Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Global variables
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isGitHubPages = window.location.hostname.includes('github.io');
        const API_BASE_URL = isLocal || isGitHubPages
            ? 'https://approvesba.vercel.app/api'
            : '/api';

        let FIREBASE_CONFIGS = {};
        let ACTIVATION_HASH = '';
        const dbs = {};
        const apps = {};
        let schools = [];
        let selectedSchool = null;
        let selectedTemplate = null;

        /**
         * Dynamic Bootstrap: Fetch configuration and initialize Firebase
         */
        async function loadBootstrapData() {
            if (window.showLoadingOverlay) window.showLoadingOverlay('Initializing Portal...', true);
            try {
                const response = await fetch(`${API_BASE_URL}/firebase-config`);
                if (!response.ok) throw new Error('Failed to load portal configuration');

                const data = await response.json();
                FIREBASE_CONFIGS = data.configs || {};
                ACTIVATION_HASH = data.activationHash || '';

                // Initialize Firestore instances dynamically
                Object.entries(FIREBASE_CONFIGS).forEach(([idx, config]) => {
                    const app = initializeApp(config, `db${idx}`);
                    apps[idx] = app;
                    dbs[idx] = initializeFirestore(app, {
                        experimentalForceLongPolling: true
                    });
                });

                console.log(`[Portal] Successfully initialized with ${Object.keys(dbs).length} databases.`);

                // If already logged in, fetch schools
                if (sessionStorage.getItem('portal_access') === 'true') {
                    await fetchAllSchools();
                }
            } catch (error) {
                console.error('[Bootstrap Error]', error);
                alert('CRITICAL: Failed to load portal configuration. Please check your connection or server status.');
            } finally {
                showLoadingOverlay('', false);
            }
        }

        // License Templates
        const LICENSE_TEMPLATES = [
            { name: 'Trial', maxStudents: 10, maxClass: 1, months: 0, days: 7, price: 'Free' },
            { name: 'Basic', maxStudents: 50, maxClass: 5, months: 12, price: 'GHS 200' },
            { name: 'Standard', maxStudents: 200, maxClass: 10, months: 12, price: 'GHS 500' },
            { name: 'Premium', maxStudents: 500, maxClass: 20, months: 12, price: 'GHS 1,000' },
            { name: 'Professional', maxStudents: 1000, maxClass: 50, months: 12, price: 'GHS 2,000' },
            { name: 'Enterprise', maxStudents: 5000, maxClass: 200, months: 12, price: 'GHS 5,000' },
            { name: 'Custom', maxStudents: 0, maxClass: 0, months: 12, price: 'Contact Sales' }
        ];



        async function hashPassword(password) {
            console.log('[Auth] Hashing password...');
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            console.log('[Auth] Generated Hash:', hashHex);
            return hashHex;
        }

        // Layer 1: Access
        window.loginPortal = async function () {
            const password = document.getElementById('portalPassword').value;
            if (!password) {
                alert('Please enter the portal password');
                return;
            }

            try {
                const hashedPassword = await hashPassword(password);
                console.log('[Auth] Sending Login Request to:', `${API_BASE_URL}/verify`);
                const response = await fetch(`${API_BASE_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: hashedPassword })
                });

                console.log('[Auth] Server Response Status:', response.status);

                if (!response.ok) {
                    const result = await response.json();
                    console.error('[Auth] Verification Failed:', response.status, result);
                    if (result.debug) {
                        console.log('[Auth] Debug Info:', result.debug);
                    }
                    alert(`Incorrect portal password. Error ${response.status}`);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    document.getElementById('loginGate').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('searchContainer').classList.remove('hidden');
                    sessionStorage.setItem('portal_access', 'true');
                    await fetchAllSchools();
                } else {
                    alert(result.message || 'Incorrect portal password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Failed to verify password. Please try again.');
            }
        }

        // Layer 2: Verification
        async function verifyMasterPassword() {
            const password = document.getElementById('activationPassword').value;
            if (!password) {
                showMessage('‚ùå Activation Master Password is required!', 'error');
                return false;
            }

            try {
                const hashedPassword = await hashPassword(password);
                const response = await fetch(`${API_BASE_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: hashedPassword })
                });

                const result = await response.json();
                if (!result.success) {
                    showMessage(`‚ùå ${result.message || 'Invalid Activation Master Password!'}`, 'error');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Verification error:', error);
                showMessage('‚ùå Verification failed. Please try again.', 'error');
                return false;
            }
        }

        async function fetchAllSchools() {
            showLoadingOverlay('Fetching Schools...', true);
            schools = [];
            const schoolList = document.getElementById('schoolList');
            schoolList.innerHTML = '<div class="text-center text-gray-500 py-4">Loading schools...</div>';

            try {
                const promises = Object.entries(dbs).map(async ([dbIndex, db]) => {
                    const snapshot = await getDocs(collection(db, 'schools'));
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // SHOW ALL SCHOOLS (Even Access: false) so we can activate them
                        schools.push({
                            id: doc.id,
                            name: data.settings?.schoolName || 'Unknown School',
                            baseName: doc.id.split('_')[0],
                            dbIndex: parseInt(dbIndex),
                            data: data,
                            access: data.Access // Store access status
                        });
                    });
                });
                await Promise.all(promises);
                schools.sort((a, b) => a.name.localeCompare(b.name));
                renderSchools();
            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('Failed to fetch schools', 'error');
            } finally {
                if (window.showLoadingOverlay) window.showLoadingOverlay('', false);
            }
        }

        function renderSchools(filter = '') {
            const schoolList = document.getElementById('schoolList');

            // GROUPING LOGIC
            const groups = {};
            schools.forEach(school => {
                // Filter first
                if (filter && !school.name.toLowerCase().includes(filter.toLowerCase()) && !school.id.toLowerCase().includes(filter.toLowerCase())) {
                    return;
                }

                if (!groups[school.baseName]) {
                    groups[school.baseName] = {
                        ...school,
                        variants: 1,
                        anyPending: school.access === false
                    };
                } else {
                    groups[school.baseName].variants++;
                    if (school.access === false) groups[school.baseName].anyPending = true;
                }
            });

            const uniqueSchools = Object.values(groups).sort((a, b) => a.name.localeCompare(b.name));

            if (uniqueSchools.length === 0) {
                schoolList.innerHTML = '<div class="text-center text-gray-500 py-8">No schools found</div>';
                return;
            }

            schoolList.innerHTML = uniqueSchools.map(school => `
                <div class="p-4 border rounded-lg hover:bg-blue-50 cursor-pointer transition-colors ${selectedSchool?.baseName === school.baseName ? 'bg-blue-100 border-blue-500 ring-2' : ''}"
                     onclick="selectSchool('${school.baseName}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-900">${school.name}</h3>
                            <p class="text-xs text-gray-500">ID: ${school.baseName} <span class="bg-gray-200 px-1 rounded text-[9px] ml-1">${school.variants} Variants</span></p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] px-2 py-1 bg-gray-100 rounded text-gray-400">DB ${school.dbIndex}</span>
                            ${school.anyPending ? '<span class="text-[10px] px-2 py-1 bg-red-100 text-red-700 rounded font-bold">PENDING</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.selectSchool = async function (baseName) {
            // Find representative (just the first match in the raw list)
            selectedSchool = schools.find(s => s.baseName === baseName);

            renderSchools(document.getElementById('searchInput').value);
            if (selectedSchool) {
                selectedSchool.existingExpiry = null; // Reset
                await loadSubscription(selectedSchool);
            }
            updateUI();
        }

        async function loadSubscription(school) {
            const baseName = school.id.split('_')[0];
            const db = dbs[school.dbIndex];
            const curExp = document.getElementById('currentExpiryDisplay');
            try {
                const subDoc = await getDoc(doc(db, 'subscriptions', baseName));
                if (subDoc.exists()) {
                    const data = subDoc.data();
                    document.getElementById('maxStudents').value = data.maxStudents || '';
                    document.getElementById('maxClass').value = data.maxClass || '';

                    if (data.expiryDate) {
                        // Calculate remaining time
                        const now = new Date();
                        const expDate = data.expiryDate.toDate();
                        school.existingExpiry = expDate;

                        const diffTime = expDate - now;
                        const isExpired = diffTime < 0;
                        const diffDays = Math.abs(Math.ceil(diffTime / (1000 * 60 * 60 * 24)));

                        // Human readable duration
                        let remainingStr = '';
                        if (diffDays > 365) {
                            const y = Math.floor(diffDays / 365);
                            const d = diffDays % 365;
                            remainingStr = `${y} Year${y > 1 ? 's' : ''} ${d} Day${d !== 1 ? 's' : ''}`;
                        } else if (diffDays > 30) {
                            const m = Math.floor(diffDays / 30);
                            const d = diffDays % 30;
                            remainingStr = `${m} Month${m > 1 ? 's' : ''} ${d} Day${d !== 1 ? 's' : ''}`;
                        } else {
                            remainingStr = `${diffDays} Day${diffDays !== 1 ? 's' : ''}`;
                        }

                        const statusColor = isExpired ? 'bg-red-50 text-red-700 border-red-200' : 'bg-blue-50 text-blue-700 border-blue-200';
                        const statusIcon = isExpired ? '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round"/>' : '<path d="M12 8v4l3 3" stroke-width="2" stroke-linecap="round"/>';

                        curExp.innerHTML = `
                            <div class="p-3 ${statusColor} border rounded-lg text-xs font-bold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">${statusIcon}</svg>
                                <div>
                                    <p class="uppercase tracking-wider text-[10px] opacity-75">${isExpired ? 'Expired' : 'Active Subscription'}</p>
                                    <p class="text-sm">${isExpired ? 'Expired ago: ' : 'Remaining: '} ${remainingStr}</p>
                                    <p class="text-[10px] opacity-75 mt-1">Existing Expiry Date: ${expDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                </div>
                            </div>`;
                        curExp.classList.remove('hidden');
                    } else {
                        curExp.classList.add('hidden');
                    }
                } else {
                    curExp.classList.add('hidden');
                    // AUTO-SELECT TRIAL FOR NEW SCHOOLS
                    applyTemplate(0);
                }
            } catch (e) {
                console.error("Load sub failed", e);
                curExp.classList.add('hidden');
            }
            // Ensure inputs are refreshed
            updateExpectedExpiry();
        }

        function updateUI() {
            const el = document.getElementById('selectedSchool');
            const form = document.getElementById('licenseForm');
            const migrate = document.getElementById('migrationPanel');
            const targetSelect = document.getElementById('targetDbSelect');

            if (selectedSchool) {
                el.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <p class="text-xs text-blue-600 font-bold uppercase mb-1">Target School</p>
                        <p class="font-bold text-lg text-gray-900">${selectedSchool.name}</p>
                        <p class="text-xs text-gray-500">Source DB: ${selectedSchool.dbIndex} | ID: ${selectedSchool.id}</p>
                    </div>`;
                form.classList.remove('hidden');
                migrate.classList.remove('hidden');

                // Populate Target DB Select
                targetSelect.innerHTML = '<option value="">Select Destination...</option>' +
                    Object.keys(dbs).filter(idx => parseInt(idx) !== selectedSchool.dbIndex)
                        .map(idx => `<option value="${idx}">Database ${idx} (${FIREBASE_CONFIGS[idx].projectId})</option>`)
                        .join('');

            } else {
                el.innerHTML = '<p class="text-gray-400 text-center py-4 italic">Select a school from the left to begin</p>';
                form.classList.add('hidden');
                migrate.classList.add('hidden');
            }
        }

        window.updateExpectedExpiry = function () {
            const val = parseInt(document.getElementById('durationValue').value) || 0;
            const unit = document.getElementById('durationUnit').value;
            const exp = document.getElementById('expectedExpiryDisplay');

            if (val === 0) { exp.classList.add('hidden'); return; }

            // Calculate from TODAY
            const date = new Date();

            // Add Duration based on Unit
            if (unit === 'days') date.setDate(date.getDate() + val);
            else if (unit === 'weeks') date.setDate(date.getDate() + (val * 7));
            else if (unit === 'months') date.setMonth(date.getMonth() + val);
            else if (unit === 'years') date.setFullYear(date.getFullYear() + val);

            exp.innerHTML = `
                <div class="p-2 bg-green-50 border border-green-200 rounded-lg text-xs font-bold text-green-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14" stroke-width="2" stroke-linecap="round"/></svg>
                    Expected Expiry: ${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
                </div>`;
            exp.classList.remove('hidden');
        }

        window.applyTemplate = function (idx) {
            const t = LICENSE_TEMPLATES[idx];
            document.getElementById('maxStudents').value = t.maxStudents;
            document.getElementById('maxClass').value = t.maxClass;

            // Auto-fill Unit & Value based on template type
            if (t.name === 'Trial') {
                document.getElementById('durationValue').value = 1;
                document.getElementById('durationUnit').value = 'weeks';
            } else {
                // Paid Plans default to 1 Year
                document.getElementById('durationValue').value = 1;
                document.getElementById('durationUnit').value = 'years';
            }

            updateExpectedExpiry();
            document.querySelectorAll('[data-template]').forEach(el => el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'));
            document.querySelector(`[data-template="${idx}"]`).classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
        }

        window.quickActivate = async function (idx) {
            const t = LICENSE_TEMPLATES[idx];
            if (!selectedSchool || !(await verifyMasterPassword())) return;
            const msg = `Quick Activate ${t.name} for ${selectedSchool.name}?\n\nStudents: ${t.maxStudents}\nClasses: ${t.maxClass}\nDuration: ${t.months}mo\n\nApplies to ALL variations of "${selectedSchool.baseName}"`;
            if (!confirm(msg)) return;

            showLoadingOverlay('Activating...', true);
            try {
                const date = new Date();
                if (t.months) date.setMonth(date.getMonth() + t.months);
                else date.setDate(date.getDate() + (t.days || 7));

                const sub = {
                    maxStudents: t.maxStudents,
                    maxClass: t.maxClass,
                    expiryDate: Timestamp.fromDate(date),
                    activationHash: ACTIVATION_HASH,
                    lastActivated: Timestamp.now()
                };

                // Write Subscription (One per base name)
                await setDoc(doc(dbs[selectedSchool.dbIndex], 'subscriptions', selectedSchool.baseName), sub);

                // BATCH UPDATE ACCESS FOR ALL VARIANTS
                const variants = schools.filter(s => s.baseName === selectedSchool.baseName);
                const updates = variants.map(variant => {
                    const schoolRef = doc(dbs[variant.dbIndex], 'schools', variant.id);
                    return setDoc(schoolRef, {
                        Access: true,
                        activationHash: ACTIVATION_HASH
                    }, { merge: true });
                });

                await Promise.all(updates);
                console.log(`[Batch Update] Granted access to ${variants.length} content variants for ${selectedSchool.baseName}`);

                alert(`‚úÖ ${t.name} activated & Access Granted for ${variants.length} variants!`);

                // Update local model to reflect change immediately without refresh
                variants.forEach(v => v.access = true);
                renderSchools(document.getElementById('searchInput').value);

                resetPortal();
            } catch (e) {
                console.error(e);
                showMessage('‚ùå Activation failed', 'error');
            } finally {
                showLoadingOverlay('', false);
            }
        }

        window.migrateSchool = async function () {
            if (!selectedSchool || !(await verifyMasterPassword())) return;
            const targetDbIndex = parseInt(document.getElementById('targetDbSelect').value);
            if (!targetDbIndex || targetDbIndex === selectedSchool.dbIndex) {
                alert('Please select a different target database.');
                return;
            }

            const baseName = selectedSchool.baseName;
            const sourceDb = dbs[selectedSchool.dbIndex];
            const targetDb = dbs[targetDbIndex];

            const msg = `MIGRATE all data for "${baseName}" from DB ${selectedSchool.dbIndex} to DB ${targetDbIndex}?\n\nThis will copy:\n- All school variants (years/terms)\n- All students and classes\n- Subscription data\n\nExisting data in the target database for this school will be OVERWRITTEN.`;
            if (!confirm(msg)) return;

            showLoadingOverlay('Starting Migration...', true);
            try {
                // 1. Fetch Subscription
                showLoadingOverlay(`Migrating Subscription: ${baseName}...`, true);
                const subDoc = await getDoc(doc(sourceDb, 'subscriptions', baseName));
                if (subDoc.exists()) {
                    await setDoc(doc(targetDb, 'subscriptions', baseName), subDoc.data());
                }

                // 2. Fetch all variants from CURRENT source list
                const variants = schools.filter(s => s.baseName === baseName && s.dbIndex === selectedSchool.dbIndex);
                let count = 0;

                for (const variant of variants) {
                    count++;
                    showLoadingOverlay(`Migrating Variant ${count}/${variants.length}: ${variant.id}...`, true);

                    // A. Migrate School Document
                    const schoolData = { ...variant.data, migratedFrom: selectedSchool.dbIndex };
                    await setDoc(doc(targetDb, 'schools', variant.id), schoolData);

                    // B. Migrate Subcollections (Recursively)
                    const subcollections = ['students', 'classes', 'terms', 'attendance', 'reports'];
                    for (const sub of subcollections) {
                        const sourceCol = collection(sourceDb, 'schools', variant.id, sub);
                        const snapshot = await getDocs(sourceCol);
                        if (!snapshot.empty) {
                            showLoadingOverlay(`Migrating ${sub} for ${variant.id} (${snapshot.size} docs)...`, true);
                            for (const d of snapshot.docs) {
                                await setDoc(doc(targetDb, 'schools', variant.id, sub, d.id), d.data());
                            }
                        }
                    }
                }

                alert(`‚úÖ Migration Complete!\n\n${variants.length} school variants moved to DB ${targetDbIndex}.\n\nIMPORTANT: Remember to update the SCHOOL_DATABASE_MAPPING in Vercel to point "${baseName}" to Database ${targetDbIndex}.`);

                // Cleanup Option
                if (confirm(`Do you want to DELETE "${baseName}" from the SOURCE Database ${selectedSchool.dbIndex} now?\n\nOnly do this if you have verified the migration and updated the Vercel mapping.`)) {
                    showLoadingOverlay(`Deleting from Source DB ${selectedSchool.dbIndex}...`, true);
                    for (const variant of variants) {
                        const subcollections = ['students', 'classes', 'terms', 'attendance', 'reports'];
                        for (const sub of subcollections) {
                            const snapshot = await getDocs(collection(sourceDb, 'schools', variant.id, sub));
                            for (const d of snapshot.docs) {
                                await deleteDoc(doc(sourceDb, 'schools', variant.id, sub, d.id));
                            }
                        }
                        await deleteDoc(doc(sourceDb, 'schools', variant.id));
                    }
                    await deleteDoc(doc(sourceDb, 'subscriptions', baseName));
                    alert('‚úÖ Data deleted from source database.');
                }

                // Refresh to show changes
                await fetchAllSchools();
                resetPortal();
            } catch (e) {
                console.error('Migration failed:', e);
                alert(`‚ùå Migration failed: ${e.message}`);
            } finally {
                showLoadingOverlay('', false);
            }
        }


        window.activateLicense = async function () {
            if (!selectedSchool || !(await verifyMasterPassword())) return;
            const s = parseInt(document.getElementById('maxStudents').value);
            const c = parseInt(document.getElementById('maxClass').value);
            const val = parseInt(document.getElementById('durationValue').value);
            const unit = document.getElementById('durationUnit').value;

            if (!s || !c || !val) { showMessage('Please fill all fields', 'error'); return; }
            if (!confirm(`Activate manual license for ${selectedSchool.name} (All Variations)?`)) return;

            showLoadingOverlay('Activating...', true);
            try {
                // Calculate Expiry Date (From TODAY)
                const date = new Date();
                if (unit === 'days') date.setDate(date.getDate() + val);
                else if (unit === 'weeks') date.setDate(date.getDate() + (val * 7));
                else if (unit === 'months') date.setMonth(date.getMonth() + val);
                else if (unit === 'years') date.setFullYear(date.getFullYear() + val);

                const sub = {
                    maxStudents: s,
                    maxClass: c,
                    expiryDate: Timestamp.fromDate(date),
                    activationHash: ACTIVATION_HASH,
                    lastActivated: Timestamp.now()
                };

                // Write Subscription
                await setDoc(doc(dbs[selectedSchool.dbIndex], 'subscriptions', selectedSchool.baseName), sub);

                // BATCH UPDATE ACCESS FOR ALL VARIANTS
                const variants = schools.filter(s => s.baseName === selectedSchool.baseName);
                const updates = variants.map(variant => {
                    const schoolRef = doc(dbs[variant.dbIndex], 'schools', variant.id);
                    return setDoc(schoolRef, {
                        Access: true,
                        activationHash: ACTIVATION_HASH
                    }, { merge: true });
                });

                await Promise.all(updates);
                console.log(`[Batch Update] Granted access to ${variants.length} content variants for ${selectedSchool.baseName}`);

                alert('‚úÖ Template activated & Access Granted!');

                // Update local model
                variants.forEach(v => v.access = true);
                renderSchools(document.getElementById('searchInput').value);

                resetPortal();
            } catch (e) {
                console.error(e);
                showMessage('‚ùå Activation failed', 'error');
            } finally {
                showLoadingOverlay('', false);
            }
        }

        function resetPortal() {
            const pwd = document.getElementById('activationPassword');
            if (pwd) pwd.value = '';
            selectedSchool = null;
            selectedTemplate = null;
            updateUI();
        }

        function showMessage(t, type) {
            const el = document.getElementById('message');
            el.textContent = t;
            el.className = `p-4 rounded-lg mb-4 text-sm font-bold shadow-sm border ${type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }

        window.showLoadingOverlay = function (text, s) {
            const el = document.getElementById('loadingText');
            if (el) el.textContent = text || 'Writing to Cloud...';
            document.getElementById('loadingOverlay').classList.toggle('hidden', !s);
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadBootstrapData();
            document.getElementById('searchInput').addEventListener('input', (e) => renderSchools(e.target.value));
            document.getElementById('durationValue').addEventListener('input', updateExpectedExpiry);
            document.getElementById('durationUnit').addEventListener('change', updateExpectedExpiry);
            document.getElementById('refreshBtn').addEventListener('click', fetchAllSchools);
        });
    </script>
    <script src="offline-activation.js"></script>
</head>

<body class="bg-gray-50 font-sans text-gray-900">
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
            <p id="loadingText" class="font-bold text-gray-700">Writing to Cloud...</p>
        </div>
    </div>

    <!-- üîë Initial Authentication Gate -->
    <div id="loginGate" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full text-center border border-gray-100">
            <div
                class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <h2 class="text-3xl font-black mb-2">Portal Access</h2>
            <p class="text-gray-500 mb-8 font-medium">Authentication is required to view schools.</p>
            <input id="portalPassword" type="password"
                class="w-full px-6 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all text-center text-2xl tracking-widest font-mono mb-6"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') loginPortal()" />
            <button onclick="loginPortal()"
                class="w-full py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-500/30">Unlock
                Portal</button>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-12 max-w-7xl hidden">
        <header class="text-center mb-16">
            <h1 class="text-6xl font-black text-gray-900 tracking-tighter mb-4">License Portal</h1>
            <p class="text-xl text-gray-500 font-medium">Activate and extend subscriptions across school databases.</p>
        </header>

        <div id="message" class="hidden"></div>

        <div class="grid lg:grid-cols-2 gap-12">
            <!-- üè´ Schools Panel -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-black tracking-tight">Schools</h2>
                    <button id="refreshBtn"
                        class="p-3 bg-gray-50 text-gray-600 rounded-xl hover:bg-gray-100 transition-all font-bold text-sm">Refresh
                        List</button>
                </div>
                <div id="searchContainer" class="relative mb-6 hidden">
                    <input id="searchInput" type="text" placeholder="Search school name..."
                        class="w-full px-6 py-4 bg-gray-50 border-2 border-transparent focus:border-blue-500 rounded-2xl outline-none transition-all font-medium" />
                </div>
                <div id="schoolList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
            </div>

            <!-- ‚öôÔ∏è Activation Panel -->
            <div class="space-y-8">
                <!-- Mode Toggle -->
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6">
                    <div class="flex gap-3">
                        <button id="onlineToggle" onclick="switchMode('online')"
                            class="flex-1 py-3 px-6 rounded-xl font-black text-sm transition-all bg-blue-600 text-white">
                            üåê Online Activation
                        </button>
                        <button id="offlineToggle" onclick="switchMode('offline')"
                            class="flex-1 py-3 px-6 rounded-xl font-black text-sm transition-all bg-gray-100 text-gray-600">
                            üíæ Offline Activation
                        </button>
                    </div>
                </div>

                <!-- Online Activation Panel -->
                <div id="onlinePanel">
                    <div id="selectedSchool" class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
                        <p class="text-gray-400 text-center py-4 italic font-medium">Select a school to configure
                            license
                        </p>
                    </div>

                    <div id="licenseForm"
                        class="hidden bg-white rounded-3xl shadow-xl border border-gray-100 p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <h2 class="text-3xl font-black tracking-tight mb-8">License Setup</h2>

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-10">
                            <button onclick="applyTemplate(0)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="0">
                                <span class="block font-black text-[11px]">Trial</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">1 Week</span>
                            </button>
                            <button onclick="applyTemplate(1)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="1">
                                <span class="block font-black text-[11px]">Basic</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                            </button>
                            <button onclick="applyTemplate(2)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="2">
                                <span class="block font-black text-[11px]">Std</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                            </button>
                            <button onclick="applyTemplate(3)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="3">
                                <span class="block font-black text-[11px]">Prem</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                            </button>
                            <button onclick="applyTemplate(4)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="4">
                                <span class="block font-black text-[11px]">Prof</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                            </button>
                            <button onclick="applyTemplate(5)"
                                class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                                data-template="5">
                                <span class="block font-black text-[11px]">Ent</span>
                                <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                            </button>
                        </div>

                        <div class="space-y-5">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 ml-1">Max Students</label>
                                    <input id="maxStudents" type="number"
                                        class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                                </div>
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 ml-1">Max Classes</label>
                                    <input id="maxClass" type="number"
                                        class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 ml-1">Duration
                                        Value</label>
                                    <input id="durationValue" type="number" min="1"
                                        class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                                </div>
                                <div>
                                    <label class="text-xs font-black uppercase text-gray-400 ml-1">Unit</label>
                                    <div class="relative">
                                        <select id="durationUnit"
                                            class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold appearance-none cursor-pointer">
                                            <option value="days">Days</option>
                                            <option value="weeks">Weeks</option>
                                            <option value="months">Months</option>
                                            <option value="years">Years</option>
                                        </select>
                                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="currentExpiryDisplay" class="hidden space-y-2"></div>
                            <div id="expectedExpiryDisplay" class="hidden space-y-2"></div>

                            <div class="bg-amber-50 p-6 rounded-3xl border-2 border-amber-100 mt-6 shadow-highlight">
                                <label class="block text-sm font-black text-amber-800 mb-3 uppercase tracking-wider">üîí
                                    Activation Master Password</label>
                                <input id="activationPassword" type="password"
                                    class="w-full px-6 py-4 bg-white/80 border-2 border-amber-200 rounded-2xl focus:border-amber-500 outline-none font-bold text-center"
                                    placeholder="Verify to activate" />
                            </div>

                            <button onclick="activateLicense()"
                                class="w-full py-5 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 transition-all shadow-xl hover:shadow-blue-500/40 text-lg uppercase tracking-widest">
                                Confirm Activation
                            </button>
                        </div>
                    </div>

                    <!-- Migration Panel -->
                    <div id="migrationPanel"
                        class="hidden bg-white rounded-3xl shadow-xl border border-gray-100 p-8 mt-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div class="flex items-center gap-3 mb-6">
                            <div
                                class="w-10 h-10 bg-amber-50 text-amber-600 rounded-full flex items-center justify-center shadow-inner">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <h2 class="text-3xl font-black tracking-tight">Database Migration</h2>
                        </div>

                        <p class="text-sm text-gray-500 mb-8 font-medium">Move this school and all associated data to a
                            different database.</p>

                        <div class="space-y-6">
                            <div class="bg-gray-50 p-6 rounded-2xl border-2 border-transparent">
                                <label class="text-xs font-black uppercase text-gray-400 ml-1">Target Database</label>
                                <div class="relative mt-2">
                                    <select id="targetDbSelect"
                                        class="w-full px-5 py-4 bg-white rounded-2xl border-2 border-gray-100 focus:border-amber-500 outline-none font-bold appearance-none cursor-pointer shadow-sm">
                                        <option value="">Select Destination...</option>
                                        <!-- Will be populated via updateUI -->
                                    </select>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-red-50 p-6 rounded-3xl border-2 border-red-100 shadow-highlight">
                                <label class="block text-sm font-black text-red-800 mb-2 uppercase tracking-wider">‚ö†Ô∏è
                                    Critical Action</label>
                                <p class="text-[11px] text-red-600 font-bold mb-4">Migration requires the Master
                                    Password and will overwrite any existing data for this ID in the target database.
                                </p>
                            </div>

                            <button onclick="migrateSchool()"
                                class="w-full py-5 bg-amber-600 text-white font-black rounded-2xl hover:bg-amber-700 transition-all shadow-xl hover:shadow-amber-500/40 text-lg uppercase tracking-widest">
                                Start Migration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Offline Activation Panel -->
                <div id="offlinePanel" class="hidden">
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
                        <h2 class="text-3xl font-black tracking-tight mb-6">Offline License Generation</h2>

                        <!-- Drop Zone -->
                        <div id="tokenDropZone"
                            class="border-4 border-dashed border-gray-200 rounded-3xl p-12 text-center mb-8 transition-all cursor-pointer hover:border-gray-300">
                            <input type="file" id="tokenFileInput" accept=".token" onchange="onTokenFileSelected(event)"
                                class="hidden">
                            <div onclick="document.getElementById('tokenFileInput').click()">
                                <div class="text-6xl mb-4">üìÑ</div>
                                <p id="dropZoneText" class="text-lg font-bold text-gray-600 mb-2">Drop .token file here
                                    or click to browse</p>
                                <p class="text-sm text-gray-400">Upload request file from SBA Pro Master desktop app</p>
                            </div>
                        </div>

                        <!-- Fields Container (hidden until file is loaded) -->
                        <div id="offlineFieldsContainer" class="hidden space-y-6">
                            <!-- Read-only fields from token -->
                            <div class="bg-gray-50 p-6 rounded-2xl space-y-4">
                                <h3 class="font-black text-sm uppercase text-gray-500 mb-4">üìã Request Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2">User Name /
                                            Company</label>
                                        <input id="offlineUserName" type="text" readonly
                                            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl font-medium text-gray-700">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2">Phone Number</label>
                                        <input id="offlinePhone" type="text" readonly
                                            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl font-medium text-gray-700">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2">Transaction ID</label>
                                        <input id="offlineTransId" type="text" readonly
                                            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl font-medium text-gray-700">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-2">Product ID</label>
                                        <input id="offlineProdId" type="text" readonly
                                            class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl font-medium text-gray-700">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">Days Remaining</label>
                                    <input id="offlineRemaining" type="text" readonly
                                        class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl font-medium text-gray-700">
                                </div>
                            </div>

                            <!-- Editable fields -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-black uppercase text-gray-400 mb-2">Requested
                                        Days</label>
                                    <input id="offlineRequested" type="number" min="1"
                                        class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold">
                                </div>
                                <div>
                                    <label class="block text-xs font-black uppercase text-gray-400 mb-2">Registration
                                        Type</label>
                                    <div class="relative">
                                        <select id="offlineRegType"
                                            class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold appearance-none cursor-pointer">
                                            <option>Trial</option>
                                            <option>Basic</option>
                                            <option>Standard</option>
                                            <option>Premium</option>
                                            <option>Professional</option>
                                            <option>Enterprise</option>
                                            <option>Full</option>
                                        </select>
                                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                                            <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Master Password -->
                            <div class="bg-amber-50 p-6 rounded-3xl border-2 border-amber-100">
                                <label class="block text-sm font-black text-amber-800 mb-3 uppercase tracking-wider">üîí
                                    Master Password</label>
                                <input id="offlinePassword" type="password"
                                    class="w-full px-6 py-4 bg-white/80 border-2 border-amber-200 rounded-2xl focus:border-amber-500 outline-none font-bold text-center"
                                    placeholder="Enter password to generate license">
                            </div>

                            <!-- Generate Button -->
                            <button onclick="generateOfflineLicense()"
                                class="w-full py-5 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 transition-all shadow-xl hover:shadow-blue-500/40 text-lg uppercase tracking-widest">
                                Generate & Download .slic File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>