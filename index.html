<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA Pro Master - License Management Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeFirestore, collection, getDocs, doc, setDoc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configurations
        const FIREBASE_CONFIGS = {
            1: {
                apiKey: "AIzaSyCe0O-mBCODiEA-KNVLXLMp00lJ6_Jt5SU",
                authDomain: "sba-pro-master-759f6.firebaseapp.com",
                projectId: "sba-pro-master-759f6",
                storageBucket: "sba-pro-master-759f6.firebasestorage.app",
                messagingSenderId: "239073604626",
                appId: "1:239073604626:web:452bc2719fc980704d14cb"
            },
            2: {
                apiKey: "AIzaSyBP6gLbFLhfbAvjB2ddXSq6zqE_gWK2MEI",
                authDomain: "sba-pro-master-40f08.firebaseapp.com",
                projectId: "sba-pro-master-40f08",
                storageBucket: "sba-pro-master-40f08.firebasestorage.app",
                messagingSenderId: "91692962474",
                appId: "1:91692962474:web:eefa6a3a04ba557c38b6d3"
            },
            3: {
                apiKey: "AIzaSyBnbpBSwA-AtorGzVefj5h3fWkAVfyDWuU",
                authDomain: "sba-pro-master-e43d0.firebaseapp.com",
                projectId: "sba-pro-master-e43d0",
                storageBucket: "sba-pro-master-e43d0.firebasestorage.app",
                messagingSenderId: "126627036834",
                appId: "1:126627036834:web:4e32313e40e5c3f752a1fb"
            }
        };

        // License Templates
        const LICENSE_TEMPLATES = [
            { name: 'Trial', maxStudents: 10, maxClass: 1, months: 0, days: 7, price: 'Free' },
            { name: 'Basic', maxStudents: 50, maxClass: 5, months: 12, price: 'GHS 200' },
            { name: 'Standard', maxStudents: 200, maxClass: 10, months: 12, price: 'GHS 500' },
            { name: 'Premium', maxStudents: 500, maxClass: 20, months: 12, price: 'GHS 1,000' },
            { name: 'Professional', maxStudents: 1000, maxClass: 50, months: 12, price: 'GHS 2,000' },
            { name: 'Enterprise', maxStudents: 5000, maxClass: 200, months: 12, price: 'GHS 5,000' },
            { name: 'Custom', maxStudents: 0, maxClass: 0, months: 12, price: 'Contact Sales' }
        ];

        let schools = [];
        let selectedSchool = null;
        let selectedTemplate = null;

        // Initialize Firebase apps
        const apps = {};
        const dbs = {};
        Object.entries(FIREBASE_CONFIGS).forEach(([idx, config]) => {
            const app = initializeApp(config, `db${idx}`);
            apps[idx] = app;
            dbs[idx] = initializeFirestore(app, {
                experimentalForceLongPolling: true
            });
        });

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Layer 1: Access
        window.loginPortal = async function () {
            const password = document.getElementById('portalPassword').value;
            if (!password) {
                alert('Please enter the portal password');
                return;
            }

            const hash = await hashPassword(password);
            if (hash === 'c93a215026f36ac783bcac8ba5e4bbea1c3cdb6c79d3824f9712143c44dbb0f3') {
                document.getElementById('loginGate').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
                sessionStorage.setItem('portal_access', 'true');
                await fetchAllSchools();
            } else {
                alert('Incorrect portal password');
            }
        }

        // Layer 2: Verification
        async function verifyMasterPassword() {
            const password = document.getElementById('activationPassword').value;
            if (!password) {
                showMessage('‚ùå Activation Master Password is required!', 'error');
                return false;
            }
            const hash = await hashPassword(password);
            if (hash !== 'c93a215026f36ac783bcac8ba5e4bbea1c3cdb6c79d3824f9712143c44dbb0f3') {
                showMessage('‚ùå Invalid Activation Master Password!', 'error');
                return false;
            }
            return true;
        }

        async function fetchAllSchools() {
            showLoading(true);
            schools = [];
            const schoolList = document.getElementById('schoolList');
            schoolList.innerHTML = '<div class="text-center text-gray-500 py-4">Loading schools...</div>';

            try {
                const promises = Object.entries(dbs).map(async ([dbIndex, db]) => {
                    const snapshot = await getDocs(collection(db, 'schools'));
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.Access !== false) {
                            schools.push({
                                id: doc.id,
                                name: data.settings?.schoolName || 'Unknown School',
                                dbIndex: parseInt(dbIndex),
                                data: data
                            });
                        }
                    });
                });
                await Promise.all(promises);
                schools.sort((a, b) => a.name.localeCompare(b.name));
                renderSchools();
            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('Failed to fetch schools', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderSchools(filter = '') {
            const schoolList = document.getElementById('schoolList');
            const filtered = schools.filter(s =>
                s.name.toLowerCase().includes(filter.toLowerCase()) ||
                s.id.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                schoolList.innerHTML = '<div class="text-center text-gray-500 py-8">No schools found</div>';
                return;
            }

            schoolList.innerHTML = filtered.map(school => `
                <div class="p-4 border rounded-lg hover:bg-blue-50 cursor-pointer transition-colors ${selectedSchool?.id === school.id ? 'bg-blue-100 border-blue-500 ring-2' : ''}"
                     onclick="selectSchool('${school.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-900">${school.name}</h3>
                            <p class="text-xs text-gray-500">ID: ${school.id}</p>
                        </div>
                        <span class="text-[10px] px-2 py-1 bg-gray-100 rounded text-gray-400">DB ${school.dbIndex}</span>
                    </div>
                </div>
            `).join('');
        }

        window.selectSchool = async function (schoolId) {
            selectedSchool = schools.find(s => s.id === schoolId);
            renderSchools(document.getElementById('searchInput').value);
            if (selectedSchool) await loadSubscription(selectedSchool);
            updateUI();
        }

        async function loadSubscription(school) {
            const baseName = school.id.split('_')[0];
            const db = dbs[school.dbIndex];
            const curExp = document.getElementById('currentExpiryDisplay');
            try {
                const subDoc = await getDoc(doc(db, 'subscriptions', baseName));
                if (subDoc.exists()) {
                    const data = subDoc.data();
                    document.getElementById('maxStudents').value = data.maxStudents || '';
                    document.getElementById('maxClass').value = data.maxClass || '';
                    document.getElementById('months').value = 12;
                    if (data.expiryDate) {
                        const date = data.expiryDate.toDate();
                        curExp.innerHTML = `
                            <div class="p-2 bg-blue-50 border border-blue-200 rounded-lg text-xs font-bold text-blue-700 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 8v4l3 3" stroke-width="2" stroke-linecap="round"/></svg>
                                Existing Expiry: ${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
                            </div>`;
                        curExp.classList.remove('hidden');
                    }
                } else {
                    document.getElementById('months').value = 12;
                    curExp.classList.add('hidden');
                }
            } catch (e) {
                curExp.classList.add('hidden');
            }
            updateExpectedExpiry();
        }

        function updateUI() {
            const el = document.getElementById('selectedSchool');
            const form = document.getElementById('licenseForm');
            if (selectedSchool) {
                el.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <p class="text-xs text-blue-600 font-bold uppercase mb-1">Target School</p>
                        <p class="font-bold text-lg text-gray-900">${selectedSchool.name}</p>
                        <p class="text-xs text-gray-500">DB: ${selectedSchool.dbIndex} | ID: ${selectedSchool.id}</p>
                    </div>`;
                form.classList.remove('hidden');
            } else {
                el.innerHTML = '<p class="text-gray-400 text-center py-4 italic">Select a school from the left to begin</p>';
                form.classList.add('hidden');
            }
        }

        window.updateExpectedExpiry = function () {
            const m = parseInt(document.getElementById('months').value) || 0;
            const exp = document.getElementById('expectedExpiryDisplay');
            if (m === 0) { exp.classList.add('hidden'); return; }
            const date = new Date();
            date.setMonth(date.getMonth() + m);
            exp.innerHTML = `
                <div class="p-2 bg-green-50 border border-green-200 rounded-lg text-xs font-bold text-green-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14" stroke-width="2" stroke-linecap="round"/></svg>
                    Expected Expiry: ${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
                </div>`;
            exp.classList.remove('hidden');
        }

        window.applyTemplate = function (idx) {
            const t = LICENSE_TEMPLATES[idx];
            document.getElementById('maxStudents').value = t.maxStudents;
            document.getElementById('maxClass').value = t.maxClass;
            document.getElementById('months').value = t.months;
            updateExpectedExpiry();
            document.querySelectorAll('[data-template]').forEach(el => el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'));
            document.querySelector(`[data-template="${idx}"]`).classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
        }

        window.quickActivate = async function (idx) {
            const t = LICENSE_TEMPLATES[idx];
            if (!selectedSchool || !(await verifyMasterPassword())) return;
            const msg = `Quick Activate ${t.name} for ${selectedSchool.name}?\n\nStudents: ${t.maxStudents}\nClasses: ${t.maxClass}\nDuration: ${t.months}mo`;
            if (!confirm(msg)) return;

            showLoading(true);
            try {
                const date = new Date();
                if (t.months) date.setMonth(date.getMonth() + t.months);
                else date.setDate(date.getDate() + (t.days || 7));

                const sub = {
                    maxStudents: t.maxStudents,
                    maxClass: t.maxClass,
                    expiryDate: Timestamp.fromDate(date),
                    activationHash: await hashPassword(document.getElementById('activationPassword').value),
                    lastActivated: Timestamp.now()
                };
                await setDoc(doc(dbs[selectedSchool.dbIndex], 'subscriptions', selectedSchool.id.split('_')[0]), sub);
                alert(`‚úÖ ${t.name} activated!`);
                resetPortal();
            } catch (e) {
                showMessage('‚ùå Activation failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        window.activateLicense = async function () {
            if (!selectedSchool || !(await verifyMasterPassword())) return;
            const s = parseInt(document.getElementById('maxStudents').value);
            const c = parseInt(document.getElementById('maxClass').value);
            const m = parseInt(document.getElementById('months').value);
            if (!s || !c || !m) { showMessage('Please fill all fields', 'error'); return; }
            if (!confirm(`Activate manual license for ${selectedSchool.name}?`)) return;

            showLoading(true);
            try {
                const date = new Date();
                date.setMonth(date.getMonth() + m);
                const sub = {
                    maxStudents: s,
                    maxClass: c,
                    expiryDate: Timestamp.fromDate(date),
                    activationHash: await hashPassword(document.getElementById('activationPassword').value),
                    lastActivated: Timestamp.now()
                };
                await setDoc(doc(dbs[selectedSchool.dbIndex], 'subscriptions', selectedSchool.id.split('_')[0]), sub);
                alert('‚úÖ Template activated!');
                resetPortal();
            } catch (e) {
                showMessage('‚ùå Activation failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        function resetPortal() {
            document.getElementById('activationPassword').value = '';
            selectedSchool = null;
            updateUI();
        }

        function showMessage(t, type) {
            const el = document.getElementById('message');
            el.textContent = t;
            el.className = `p-4 rounded-lg mb-4 text-sm font-bold shadow-sm border ${type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }

        function showLoading(s) { document.getElementById('loadingOverlay').classList.toggle('hidden', !s); }

        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('portal_access') === 'true') {
                document.getElementById('loginGate').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
                fetchAllSchools();
            }
            document.getElementById('searchInput').addEventListener('input', (e) => renderSchools(e.target.value));
            document.getElementById('months').addEventListener('input', updateExpectedExpiry);
            document.getElementById('refreshBtn').addEventListener('click', fetchAllSchools);
        });
    </script>
</head>

<body class="bg-gray-50 font-sans text-gray-900">
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
            <p class="font-bold text-gray-700">Writing to Cloud...</p>
        </div>
    </div>

    <!-- üîë Initial Authentication Gate -->
    <div id="loginGate" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full text-center border border-gray-100">
            <div
                class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <h2 class="text-3xl font-black mb-2">Portal Access</h2>
            <p class="text-gray-500 mb-8 font-medium">Authentication is required to view schools.</p>
            <input id="portalPassword" type="password"
                class="w-full px-6 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all text-center text-2xl tracking-widest font-mono mb-6"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') loginPortal()" />
            <button onclick="loginPortal()"
                class="w-full py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition-all shadow-lg hover:shadow-blue-500/30">Unlock
                Portal</button>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-12 max-w-7xl hidden">
        <header class="text-center mb-16">
            <h1 class="text-6xl font-black text-gray-900 tracking-tighter mb-4">License Portal</h1>
            <p class="text-xl text-gray-500 font-medium">Activate and extend subscriptions across school databases.</p>
        </header>

        <div id="message" class="hidden"></div>

        <div class="grid lg:grid-cols-2 gap-12">
            <!-- üè´ Schools Panel -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-black tracking-tight">Schools</h2>
                    <button id="refreshBtn"
                        class="p-3 bg-gray-50 text-gray-600 rounded-xl hover:bg-gray-100 transition-all font-bold text-sm">Refresh
                        List</button>
                </div>
                <div id="searchContainer" class="relative mb-6 hidden">
                    <input id="searchInput" type="text" placeholder="Search school name..."
                        class="w-full px-6 py-4 bg-gray-50 border-2 border-transparent focus:border-blue-500 rounded-2xl outline-none transition-all font-medium" />
                </div>
                <div id="schoolList" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
            </div>

            <!-- ‚öôÔ∏è Activation Panel -->
            <div class="space-y-8">
                <div id="selectedSchool" class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
                    <p class="text-gray-400 text-center py-4 italic font-medium">Select a school to configure license
                    </p>
                </div>

                <div id="licenseForm"
                    class="hidden bg-white rounded-3xl shadow-xl border border-gray-100 p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h2 class="text-3xl font-black tracking-tight mb-8">License Setup</h2>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-10">
                        <button onclick="applyTemplate(0)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="0">
                            <span class="block font-black text-[11px]">Trial</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">1 Week</span>
                        </button>
                        <button onclick="applyTemplate(1)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="1">
                            <span class="block font-black text-[11px]">Basic</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                        </button>
                        <button onclick="applyTemplate(2)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="2">
                            <span class="block font-black text-[11px]">Std</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                        </button>
                        <button onclick="applyTemplate(3)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="3">
                            <span class="block font-black text-[11px]">Prem</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                        </button>
                        <button onclick="applyTemplate(4)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="4">
                            <span class="block font-black text-[11px]">Prof</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                        </button>
                        <button onclick="applyTemplate(5)"
                            class="p-3 border-2 border-gray-50 rounded-2xl hover:border-blue-200 transition-all text-left"
                            data-template="5">
                            <span class="block font-black text-[11px]">Ent</span>
                            <span class="text-[9px] text-gray-400 font-bold uppercase">12mo</span>
                        </button>
                    </div>

                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-black uppercase text-gray-400 ml-1">Max Students</label>
                                <input id="maxStudents" type="number"
                                    class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                            </div>
                            <div>
                                <label class="text-xs font-black uppercase text-gray-400 ml-1">Max Classes</label>
                                <input id="maxClass" type="number"
                                    class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-black uppercase text-gray-400 ml-1">Duration (Months)</label>
                            <input id="months" type="number"
                                class="w-full px-5 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none font-bold" />
                        </div>

                        <div id="currentExpiryDisplay" class="hidden space-y-2"></div>
                        <div id="expectedExpiryDisplay" class="hidden space-y-2"></div>

                        <div class="bg-amber-50 p-6 rounded-3xl border-2 border-amber-100 mt-6 shadow-highlight">
                            <label class="block text-sm font-black text-amber-800 mb-3 uppercase tracking-wider">üîí
                                Activation Master Password</label>
                            <input id="activationPassword" type="password"
                                class="w-full px-6 py-4 bg-white/80 border-2 border-amber-200 rounded-2xl focus:border-amber-500 outline-none font-bold text-center"
                                placeholder="Verify to activate" />
                        </div>

                        <button onclick="activateLicense()"
                            class="w-full py-5 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 transition-all shadow-xl hover:shadow-blue-500/40 text-lg uppercase tracking-widest">
                            Confirm Activation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>